<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GL Entry Tool</title>
  <style>
    :root{
      --bg:#f7f9fc; --card:#ffffff; --ink:#0f172a; --muted:#64748b; --border:#e2e8f0; --accent:#2563eb;
    }
    *{box-sizing:border-box}
    body{margin:0;padding:24px;background:var(--bg);color:var(--ink);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    h1{margin:0 0 6px;font-size:22px}
    .sub{color:var(--muted);margin-bottom:16px}
    .wrap{display:grid;grid-template-columns:1.2fr 2fr;gap:16px;align-items:start}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 2px 10px rgba(2,6,23,.04)}
    .controls{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px}
    button,select,input[type="text"],input[type="month"]{border:1px solid var(--border);background:#fff;color:var(--ink);padding:8px 10px;border-radius:10px;font-size:13px}
    button:hover{border-color:var(--accent)}
    .row{display:grid;grid-template-columns:180px 1fr 0.8fr;gap:8px;align-items:start}
    .row+.row{margin-top:8px}
    .pill{font-size:11px;padding:2px 8px;border:1px solid var(--border);border-radius:999px;color:var(--muted);background:#fff}
    .total{font-weight:700;font-size:16px}
    .amount{width:100%;text-align:right}
    .descInput{width:100%}
    .grid{display:grid;gap:10px}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .small{font-size:12px}
    .divider{height:1px;background:var(--border);margin:8px 0}
    .stickyFooter{position:sticky;bottom:0;background:var(--card);border-top:1px solid var(--border);padding:8px;border-radius:0 0 14px 14px;display:flex;gap:10px;align-items:center}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .note{color:var(--muted);font-size:12px}
    .search{width:100%}
    .computed{background:#f1f5f9}
    .copyWrap{display:flex;gap:8px;align-items:center}
    .copyBtn{cursor:pointer}
    .readonly{background:#f8fafc}
  </style>
</head>
<body>
  <header class="card">
    <h1>GL Entry Tool</h1>
    <div class="sub">
      GLs and base descriptions are hard-coded from your sheet. Lines with a colon <span class="mono">:</span> allow a memo. 
      The <b>Total</b> auto-sums the four top items and cannot be edited. Right-side figures show as positive.
    </div>
    <div class="controls">
      <input id="period" type="month" />
      <button id="newPeriod">Start Period</button>
      <button id="save">Save</button>
      <button id="exportCsv">Export CSV</button>
      <button id="exportJson">Export JSON</button>
      <label class="pill"><input id="showZero" type="checkbox" checked> Show zero rows</label>
      <input id="q" class="search" placeholder="Search GL or descriptionâ€¦" />
    </div>
    <div class="divider"></div>
    <div class="copyWrap">
      <div class="pill">Airbase Description</div>
      <input id="airbaseDesc" class="descInput mono readonly" type="text" readonly />
      <button id="copyDesc" class="copyBtn">Copy</button>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="flex">
        <div class="pill">GL Count: <span id="glCount"></span></div>
        <div class="pill">Memo-enabled: <span id="memoCount"></span></div>
        <div class="right total">Total: <span id="grandTotal" class="mono">$0.00</span></div>
      </div>
      <div class="divider"></div>
      <div id="rows" class="grid"></div>
      <div class="stickyFooter">
        <div class="total">Total: <span id="grandTotal2" class="mono">$0.00</span></div>
        <div class="right note">Tip: Enter formats on blur/Enter. Switch the month to keep period-specific values.</div>
      </div>
    </section>

    <aside class="card">
      <h3 style="margin-top:0">Summary</h3>
      <div id="summary"></div>
    </aside>
  </main>

  <script>
    /* ==== DATA FROM YOUR SHEET (unchanged) ==== */
    const SEED = {data: {records: [
      {"gl": "Total Revenue", "base": "", "allowMemo": false},
      {"gl": "Management Fee & platform fee", "base": "", "allowMemo": false},
      {"gl": "Housekeeping & Supplies Fees", "base": "", "allowMemo": false},
      {"gl": "OTA & host fees", "base": "", "allowMemo": false},
      {"gl": "Total", "base": "Invoice Total (auto-summed from the four lines below)", "allowMemo": false},
      {"gl": "Rent & Lease Expense", "base": "", "allowMemo": false},
      {"gl": "Rent & Lease Expense - 20%", "base": "", "allowMemo": false},
      {"gl": "Commercial Rent - Sales Tax", "base": "", "allowMemo": false},
      {"gl": "Commercial Rent - Sales Tax - 20%", "base": "", "allowMemo": false},
      {"gl": "Sales Tax Credit", "base": "", "allowMemo": false},
      {"gl": "Facilities Management Program Charge", "base": "", "allowMemo": false},
      {"gl": "CAM Expense", "base": "", "allowMemo": false},
      {"gl": "CAM Expense- 20%", "base": "", "allowMemo": false},
      {"gl": "Common Area Maintenance", "base": "", "allowMemo": false},
      {"gl": "Fees - Linens & Soft Goods", "base": "", "allowMemo": false},
      {"gl": "Laundry - Linens & Soft Goods", "base": "", "allowMemo": false},
      {"gl": "Fees - Household", "base": "", "allowMemo": false},
      {"gl": "Laundry - Household", "base": "", "allowMemo": false},
      {"gl": "FYI", "base": "", "allowMemo": false},
      {"gl": "Janitorial Supplies & Tools", "base": "", "allowMemo": false},
      {"gl": "Outside Services - Electrical", "base": "", "allowMemo": false},
      {"gl": "Outside Services - Furniture Repair", "base": "", "allowMemo": false},
      {"gl": "Gas - Propane", "base": "", "allowMemo": false},
      {"gl": "Pool & Spa care", "base": "", "allowMemo": false},
      {"gl": "Outside Services - Plumbing", "base": "", "allowMemo": false},
      {"gl": "Outside Services - Building Reactive", "base": "", "allowMemo": false},
      {"gl": "Outside Services - Permits", "base": "", "allowMemo": false},
      {"gl": "Unit Items & Small Appliances", "base": "", "allowMemo": false},
      {"gl": "Seasonal Decor and Supplies", "base": "", "allowMemo": false},
      {"gl": "FM: Team Events", "base": "", "allowMemo": false},
      {"gl": "Owner Collections/Payments in", "base": "", "allowMemo": false},
      {"gl": "Unit Supplies", "base": "", "allowMemo": false},
      {"gl": "Reactive Supplies - Electrical", "base": "", "allowMemo": false},
      {"gl": "Reactive Supplies - Grounds", "base": "", "allowMemo": false},
      {"gl": "Photography & Staging Expenses", "base": "", "allowMemo": false},
      {"gl": "Outside Services - HVAC - Reactive", "base": "", "allowMemo": false},
      {"gl": "Guest Relations", "base": "", "allowMemo": false},
      {"gl": "Reactive Supplies - Plumbing", "base": "", "allowMemo": false},
      {"gl": "Owner Stay Expense", "base": "", "allowMemo": false},
      {"gl": "CAPEX", "base": "", "allowMemo": false},
      {"gl": "Reactive Supplies - Other", "base": "", "allowMemo": false},
      {"gl": "Outside Services - Signage", "base": "", "allowMemo": false},
      {"gl": "Reactive Supplies - HVAC", "base": "", "allowMemo": false},
      {"gl": "Broker Fee", "base": "", "allowMemo": false},
      {"gl": "Outside Services - Building", "base": "", "allowMemo": false}
    ]}};

    /* ==== CONSTANTS ==== */
    const COMPONENT_GLS = [
      "Total Revenue",
      "Management Fee & platform fee",
      "Housekeeping & Supplies Fees",
      "OTA & host fees"
    ];
    const TOTAL_GL_NAME = "Total";

    /* ==== HELPERS ==== */
    const $ = sel => document.querySelector(sel);
    const fmt = n => (isNaN(n)?0:n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    const parseAmt = v => { if (!v) return 0; v = String(v).replace(/[,\\s\\$]/g,""); return parseFloat(v)||0; };
    const key = p => `gltool:${p}`;
    const load = p => { try { return JSON.parse(localStorage.getItem(key(p)))||{} } catch { return {} } };
    const save = (p,m) => localStorage.setItem(key(p), JSON.stringify(m));
    const csvEscape = s => { s=String(s); return /[",\\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s; };

    /* ==== STATE ==== */
    let period = new Date().toISOString().slice(0,7);
    let filter = "";
    const base = SEED.data.records;
    const rowsDiv = $("#rows"), summaryDiv = $("#summary");

    /* ==== CORE LOGIC ==== */
    function findRecKeyByGL(glName){
      const r = base.find(b => b.gl === glName);
      return r ? (r.gl + "||" + r.base) : null;
    }
    function computeComponentAmounts(store){
      const result = [];
      COMPONENT_GLS.forEach(gl => {
        const k = findRecKeyByGL(gl);
        const amt = k && store[k] ? parseAmt(store[k].amount) : 0;
        result.push({gl, amount: amt});
      });
      return result;
    }
    function computeAirbaseDescription(store){
      // POSITIVE values in parentheses (absolute value)
      const parts = computeComponentAmounts(store).map(x => `${x.gl} (${fmt(Math.abs(x.amount))})`);
      return parts.join(", ");
    }
    function computeTotalFromComponents(store){
      // Signed sum for correctness; we DISPLAY positive
      return computeComponentAmounts(store).reduce((a,b)=>a+b.amount,0);
    }

    /* ==== RENDER ==== */
    function render(){
      $("#period").value = period;
      const store = load(period);
      rowsDiv.innerHTML = "";

      // Airbase description (absolute values) in the top box
      const airbaseLine = computeAirbaseDescription(store);
      $("#airbaseDesc").value = airbaseLine;

      const items = base.filter(r => !filter || (r.gl + " " + r.base).toLowerCase().includes(filter));

      items.forEach(r => {
        const recKey = r.gl + "||" + r.base;
        const isTotalRow = (r.gl === TOTAL_GL_NAME);
        const existing = store[recKey] || { memo: "", amount: 0 };

        const row = document.createElement("div");
        row.className = "row" + (isTotalRow ? " computed" : "");
        row.dataset.key = recKey;

        const gl = document.createElement("div");
        gl.className = "mono";
        gl.textContent = r.gl;

        const descWrap = document.createElement("div");
        const descTop = document.createElement("div");
        const baseSpan = document.createElement("span");
        baseSpan.textContent = r.base || (isTotalRow ? "Total (auto-calculated)" : "");
        descTop.appendChild(baseSpan);

        if (r.allowMemo && !isTotalRow) {
          const memoBadge = document.createElement("span");
          memoBadge.className = "pill";
          memoBadge.style.marginLeft = "8px";
          memoBadge.textContent = "memo";
          descTop.appendChild(memoBadge);
        }
        descWrap.appendChild(descTop);

        let amountInput = document.createElement("input");
        amountInput.type = "text";
        amountInput.inputMode = "decimal";
        amountInput.className = "amount mono";

        if (isTotalRow){
          // DISPLAY positive total (from the four items)
          amountInput.readOnly = true;
          amountInput.classList.add("readonly");
          const setComputed = () => {
            const s = load(period);
            const t = computeTotalFromComponents(s);
            amountInput.value = fmt(Math.abs(t));
            updateHeaderAndSummary(); // keep header + summary in sync
          };
          setComputed();
        } else {
          amountInput.value = existing.amount || "";
          amountInput.placeholder = "0.00";
          const normalize = () => {
            const s = load(period);
            const rec = s[recKey] || {};
            const n = parseAmt(amountInput.value);
            rec.amount = n;
            s[recKey] = rec;
            save(period, s);
            amountInput.value = n ? fmt(n) : "";
            updateHeaderAndSummary();
            render(); // refresh computed total line display
          };
          amountInput.addEventListener("blur", normalize);
          amountInput.addEventListener("keydown", (e) => { if (e.key === "Enter"){ e.preventDefault(); normalize(); }});
        }

        row.appendChild(gl);
        row.appendChild(descWrap);
        row.appendChild(amountInput);
        rowsDiv.appendChild(row);
      });

      updateHeaderAndSummary();
      toggleZeroRows();
    }

    /* ==== HEADER & SUMMARY (both DISPLAY positive) ==== */
    function updateHeaderAndSummary(){
      const s = load(period);
      const compTotal = computeTotalFromComponents(s);
      const display = fmt(Math.abs(compTotal));

      // Header totals (both spots)
      document.getElementById("grandTotal").textContent = "$" + display;
      document.getElementById("grandTotal2").textContent = "$" + display;

      // Summary = the amount as a whole (positive) + muted Airbase line underneath
      const airbaseLine = computeAirbaseDescription(s);
      document.getElementById("summary").innerHTML =
        `<div class="total">Total (Airbase): <span class="mono">$${display}</span></div>
         <div class="small" style="color:var(--muted);margin-top:6px">${airbaseLine || "â€”"}</div>`;

      // Also mirror Airbase line to the top copy box
      document.getElementById("airbaseDesc").value = airbaseLine;
    }

    function toggleZeroRows(){
      const show = document.getElementById("showZero").checked;
      const s = load(period);
      document.querySelectorAll("#rows .row").forEach(row => {
        const rec = s[row.dataset.key] || {};
        const amt = parseAmt(rec.amount);
        const isTotal = row.dataset.key.startsWith("Total||");
        row.style.display = (show || amt || isTotal) ? "grid" : "none";
      });
    }

    /* ==== EVENTS ==== */
    document.getElementById("period").addEventListener("change", e => { period = e.target.value || period; render(); });
    document.getElementById("newPeriod").addEventListener("click", () => {
      const p = document.getElementById("period").value; if (!p) return;
      period = p;
      const tmpl = {};
      SEED.data.records.forEach(r => { tmpl[r.gl + "||" + r.base] = { memo:"", amount:0 }; });
      save(period, tmpl);
      render();
    });
    document.getElementById("save").addEventListener("click", () => { save(period, load(period)); alert("Saved for period " + period); });
    document.getElementById("exportCsv").addEventListener("click", () => {
      const s = load(period);
      // Export Total as displayed (positive)
      const totalKey = findRecKeyByGL("Total");
      if (totalKey) { s[totalKey] = {memo:"", amount: Math.abs(computeTotalFromComponents(s))}; }
      const rows = [["Period","GL","Description","Amount"]];
      Object.entries(s).forEach(([k,v]) => {
        const [gl, base] = k.split("||");
        rows.push([period, gl, base + (v.memo?": "+v.memo:""), parseAmt(v.amount)])
      });
      const csv = rows.map(r => r.map(csvEscape).join(",")).join("\\n");
      const blob = new Blob([csv], {type:"text/csv"});
      const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `gl-entries-${period}.csv`; a.click();
    });
    document.getElementById("exportJson").addEventListener("click", () => {
      const s = load(period);
      const totalKey = findRecKeyByGL("Total");
      if (totalKey) { s[totalKey] = {memo:"", amount: Math.abs(computeTotalFromComponents(s))}; }
      const blob = new Blob([JSON.stringify({period, entries: s}, null, 2)], {type:"application/json"});
      const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `gl-entries-${period}.json`; a.click();
    });
    document.getElementById("showZero").addEventListener("change", toggleZeroRows);
    document.getElementById("q").addEventListener("input", e => { filter = (e.target.value || "").toLowerCase(); render(); });
    document.getElementById("copyDesc").addEventListener("click", async () => {
      const v = document.getElementById("airbaseDesc").value;
      try { await navigator.clipboard.writeText(v); alert("Airbase description copied!"); } catch { 
        document.getElementById("airbaseDesc").select(); document.execCommand("copy"); alert("Copied."); 
      }
    });

    // Kick off
    render();
  </script>
</body>
</html>
